<?xml version="1.0"?>
<root>
  <OBJECT NAME="GRUPO_LOJA">
    <METHOD NAME="VALIDAR_LIMITE" DESCRIPTION="" VERSION="67" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="PEDIDOV" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Cliente" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="STATUS" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="Status" CTAB="0"/>
        <FIELD NAME="PEDIDOV" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="8" FIELDLABEL="Pedidov" CTAB="0"/>
        <FIELD NAME="CLIENTE" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="4" FIELDLABEL="Cliente" CTAB="0"/>
        <FIELD NAME="LIMITE_CREDITO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="5" FIELDLABEL="Limite Credito" CTAB="0"/>
        <FIELD NAME="LIMITE_UTILIZADO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="7" FIELDLABEL="Limite Utilizado" CTAB="0"/>
        <FIELD NAME="LIMITE_DISPONIVEL" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="6" FIELDLABEL="Limite Disponivel" CTAB="0"/>
        <FIELD NAME="TOTAL" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="9" FIELDLABEL="Total" CTAB="0"/>
        <FIELD NAME="OBS" SIZE="100" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Obs" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>#PRIVATE()
SELECT:CLI C.GRUPO_LOJA, C.CLIENTE
FROM PEDIDO_VENDA PV
INNER JOIN CLIENTES C ON C.CLIENTE=PV.CLIENTE
LEFT JOIN CONDICOES_PGTO CP ON CP.CONDICOES_PGTO=PV.CONDICOES_PGTO
WHERE PV.PEDIDOV = :PEDIDOV;

#CALL:NEW_CREDIT MILLENIUM_OMNI.POS.GETCREDITINFO(storeGroup=:CLI.GRUPO_LOJA, customerID=:CLI.CLIENTE);

#SET(V_TOTAL,{(SELECT
PV.TOTAL
FROM PEDIDO_VENDA PV
INNER JOIN CLIENTES C ON C.CLIENTE = PV.CLIENTE
LEFT JOIN grupo_lojas G ON G.GRUPO_LOJA = C.GRUPO_LOJA
LEFT JOIN CONDICOES_PGTO CP ON CP.CONDICOES_PGTO=PV.CONDICOES_PGTO
WHERE PV.PEDIDOV = :PEDIDOV
AND NOT EXISTS (SELECT *
	FROM LANCAMENTOS L
	INNER JOIN TIPOS_PGTOS TP ON TP.TIPO_PGTO = L.TIPO_PGTO
	INNER JOIN TIPOS_PGTOS_NATUREZA TPN ON TPN.CODIGO = TP.NATUREZA
  WHERE L.TIPO='R'
    AND L.TIPO_ORIGEM ='V'
    AND L.ORIGEM = PV.PEDIDOV
    AND TPN.CODIGO IN (0,101,102,1,203,205,4,5,999,998,6,7,8,9,206,207,208,209,210,211,212,213,214)))
});

SELECT
PV.PEDIDOV                                                                    AS PEDIDOV
,PV.CLIENTE                                                                   AS CLIENTE
,#REPLACET(:NEW_CREDIT.LIMITE_CREDITO)                                        AS LIMITE_CREDITO
,#REPLACET(:NEW_CREDIT.LIMITE_UTILIZADO)                                      AS LIMITE_UTILIZADO
,#REPLACET(:NEW_CREDIT.LIMITE_DISPONIVEL)                                     AS LIMITE_DISPONIVEL
,(#NULL_TO_Z(#REPLACE(V_TOTAL)))                                              AS TOTAL
,CASE
WHEN (#NULL_TO_Z(#REPLACE(V_TOTAL))) = 0                                                                                           THEN 'A'
WHEN (#NULL_TO_Z(#REPLACE(V_TOTAL))+(#REPLACET(:NEW_CREDIT.LIMITE_UTILIZADO))) &lt; (#REPLACET(:NEW_CREDIT.LIMITE_CREDITO))          THEN 'A'
WHEN (#NULL_TO_Z(#REPLACE(V_TOTAL))+(#REPLACET(:NEW_CREDIT.LIMITE_UTILIZADO))) / (#REPLACET(:NEW_CREDIT.LIMITE_CREDITO)) &lt;= '1.2' THEN 'G'
WHEN (#NULL_TO_Z(#REPLACE(V_TOTAL))+(#REPLACET(:NEW_CREDIT.LIMITE_UTILIZADO))) / (#REPLACET(:NEW_CREDIT.LIMITE_CREDITO)) > '1.2'  THEN 'D'
END                                                                         AS STATUS
FROM PEDIDO_VENDA PV
INNER JOIN CLIENTES C ON C.CLIENTE = PV.CLIENTE
LEFT JOIN grupo_lojas G ON G.GRUPO_LOJA = C.GRUPO_LOJA
LEFT JOIN CONDICOES_PGTO CP ON CP.CONDICOES_PGTO=PV.CONDICOES_PGTO
WHERE PV.PEDIDOV = :PEDIDOV
;




  
  
  
  
  
  
  
  
  
  
  
  


</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>