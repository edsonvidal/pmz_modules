<?xml version="1.0"?>
<root>
  <OBJECT NAME="ENTRADAS">
    <METHOD NAME="BKP" DESCRIPTION="" VERSION="1" THREADSAFE="0">
      <PARAMS/>
      <FIELDS/>
      <ACTIONSCRIPT>/*
Gerar recebimento de compra por chamada via API

testar millenium!mnfe.minst
*/

//Consulta a filial e conta padr&#227;o
#PRIVATE()
SELECT:FL FILIAL, CONTA FROM FILIAIS WHERE COD_FILIAL=:COD_FILIAL ;

//Consulta o fornecedor franqueador
#PRIVATE()
SELECT:FO FORNECEDOR FROM FORNECEDORES WHERE CGC=:CNPJ_FORNECEDOR;

//Consulta Evento
#PRIVATE()
SELECT:EV EVENTO FROM EVENTOS WHERE CODIGO=:COD_EVENTO;

//Cosulta condi&#231;&#227;o de pagamento
#PRIVATE()
SELECT:CP CONDICOES_PGTO FROM CONDICOES_PGTO WHERE CODIGO=:COD_CONDICAO_PGTO

//Consulta Tabela de pre&#231;o
#PRIVATE()
SELECT:TP TABELA_PRECO FROM TABEBAS_PRECO WHERE COD_TPRECO=:COD_TABELA_PRECO

//Consulta Transportadora
#PRIVATE()
SELECT:TRANSP TRANSPORTADORA FROM TRANSPORTADORAS WHERE CGC=:CNPJ_TRANSPORTADORA;

//Cria tabela temporaria para armazenamento e tratamento dos dados
#SET(TBPROD, ${#CREATETABLE( PRODUTO            INTEGER
                            ,COR                INTEGER
                            ,ESTAMPA            INTEGER
                            ,TAMANHO            VARCHAR(5)
                            ,ITEM               VARCHAR(20)
                            ,QUANTIDADE         INTEGER
                            ,PRECO              DOUBLE PRECISION
                            ,COD_PRODUTO        VARCHAR(60)
                            ,TIPO_PROD          VARCHAR(2)
                            )
              }
);

//Percorre o registro de produtos e colocar os dados em tabela temporaria
#PRIVATE()
#EACH() PRODUTOS AS RS
    INSERT INTO #REPLACE(TBPROD) (
       PRODUTO
      ,COR
      ,ESTAMPA
      ,TAMANHO
      ,ITEM
      ,QUANTIDADE
      ,PRECO
      ,COD_PRODUTO
      ,TIPO_PROD
    )
    VALUES (
       :RS.PRODUTO
      ,:RS.COR
      ,:RS.ESTAMPA
      ,:RS.TAMANHO
      ,:RS.ITEM
      ,:RS.QUANTIDADE
      ,:RS.PRECO
      ,:RS.COD_PRODUTO
      ,:RS.TIPO_PROD
    );

//Prepara os registros da tabela temporaria para envio ao registro do movimento
#PRIVATE()
#EACH()
SELECT:P
  PRODUTO
 ,COR
 ,ESTAMPA
 ,TAMANHO
 ,ITEM
 ,QUANTIDADE
 ,PRECO
 ,COD_PRODUTO
 ,TIPO_PROD
FROM #REPLACE(TBPROD) E
GROUP BY
  PRODUTO
 ,COR
 ,ESTAMPA
 ,TAMANHO
 ,ITEM
 ,QUANTIDADE
 ,PRECO
 ,COD_PRODUTO
 ,TIPO_PROD

#BEGIN
  SELECT:SKU
    PS.PRODUTO     AS PRODUTO
   ,PS.COR         AS COR
   ,PS.ESTAMPA     AS ESTAMPA
   ,PS.TAMANHO     AS TAMANHO
   ,PP.COD_PRODUTO AS COD_PRODUTO
  FROM PRODUTO_SKU PS
    INNER JOIN PRODUTOS PP ON PP.PRODUTO = PS.PRODUTO

  //#SELECT(SKU._EOF, TRUE:{#CHECK("SELECT COUNT(*) AS N FROM DUAL",N>0,"Produto n&#227;o econtrado !")},ELSE:{
  #BEGIN
    UPDATE #REPLACE(TBPROD) PRD
      SET
        PRD.PRODUTO = :SKU.PRODUTO
       ,PRD.COR     = :SKU.COR
       ,PRD.ESTAMPA = :SKU.ESTAMPA
       ,PRD.TAMANHO = :SKU.TAMANHO
    WHERE PRD.COD_PRODUTO = :SKU.COD_PRODUTO;
  #END;
  //});
  

#END;

//Consulta os produtos do movimento de origem
#PRIVATE()
SELECT:PRODUTOS_MOVIMENTO
  PE.PRODUTO
 ,PE.COR
 ,PE.ESTAMPA
 ,PE.TAMANHO
 ,PE.ITEM
 ,PE.QUANTIDADE
 ,PE.UNIDADE_USO       AS UNIDADE
 ,PE.TIPO_PROD         AS TIPO
 //,PE.PRECO
 //,PE.PRECO_APLICADO
 //,PE.PRECO_BRUTO
 //,PE.PRECO_TOTAL
 //,#REPLACE(:FILIAL_FRANQUIA.CFOP) AS CFOP
 //,PE.NOTA
 //,PE.ICM
 //,PE.BICM
 //,PE.V_ICMS
 //,'IIPC' AS NCREDITA_IMP
 //,PE.IPI
 //,PE.BICMSUB
 //,PE.ICMSS
 //,PE.V_ICMSS
 //,PE.V_IPI
 //,PE.BIPI
 //,ICM_ORIG
 //,ICM_ORIG
 //,BICM_ORIG
 ////,PE.NOTA_REF
 ////,PE.TIPO_OPERACAO_REF
 ////,PE.COD_OPERACAO_REF
FROM #REPLACE(TBPROD) PE
  INNER JOIN PRODUTOS P ON P.PRODUTO = PE.PRODUTO
WHERE PE.PRODUTO IS NOT NULL

//Consulta os titulos
//SELECT:LANCAMENTOS_MOVIMENTO
//  L1.N_DOCUMENTO AS DOCUMENTO
// ,L1.DATA_EMISSAO
// ,L1.DATA_VENCIMENTO
// ,(L1.VALOR_INICIAL*-1) AS VALOR_INICIAL
// ,L1.TIPO_PGTO
// ,L1.TITULO
// ,FL.FILIAL
// ,FL.CONTA
// ,L1.PERCENTUAL_JUROS
// ,L1.VALOR_JUROS
// ,ABS(L1.VALOR_CALCULADO) AS VALOR_CALCULADO
//FROM LANCAMENTOS L1
//  INNER JOIN CLIENTES C ON C.CLIENTE = L1.COD
//  INNER JOIN FILIAIS FL ON FL.GERADOR = C.GERADOR
//WHERE L1.TIPO_ORIGEM='S'
//  AND L1.ORIGEM=:COD_OPERACAO
//  AND L1.IMPOSTO IS NULL;

//Consulta a NF gerada para o franqueado
//SELECT:NOTA_MOVIMENTO
//  NOTA
// ,ICMS
// ,V_ICMS
////,#REPLACE(:FILIAL_FRANQUIA.CFOP) AS NATUREZA_OPERACAO
// ,VALOR
// ,IPI
// ,V_IPI
// ,ICMSS
// ,V_ICMSS
// ,SEQUENCIA
// ,NUMERO_NOTA
// ,SERIE
// ,DATA
// ,"E" AS TIPO_NOTA
// ,V_ISS
//,B_ISS
// ,MODELO
// ,OBS
////,NROECF_IMPR
////,N_FABR_IMPR
////,V_PIS
// //,B_PIS
// //,V_COFINS
// //,B_COFINS
// //,ABAT_PIS_COFINS
// //,PIS
// //,COFINS
// //,DESC_SUFRAMA
// //,ICMSSE
// //,IMPOSTO_IMPORTACAO
// //,B_IMPOSTO_IMPORTACAO
// //,V_IMPOSTO_IMPORTACAO
// //,PIS_IMPORTACAO
// //,B_PIS_IMPORTACAO
// //,V_PIS_IMPORTACAO
// //,COFINS_IMPORTACAO
// //,B_COFINS_IMPORTACAO
// //,V_COFINS_IMPORTACAO
// //,SISCOMEX
// //,B_SISCOMEX
// //,V_SISCOMEX
// //,CPF
// //,F.CNPJ
//   //,'L' AS TIPO_GERADOR_IG
//   //,:FILIAL_FRANQUIA.IE AS IE_IG
// ,NAOCONTRIBUINTE_ICMS_IG
// ,IPI_NAOINCIDE_ICMS_IG
/// ,B_IPI_AGR_IMPORTACAO
// ,V_IPI_AGR_IMPORTACAO
// ,ICMSS_ANT
// ,V_ICMSS_ANT
// ,USA_IVA_COLB
// //,UFEMBARQUE_EXPORT
// //,LOCEMBARQUE_EXPORT
// //,CONTING_FILIAL
// //,CONTING_JUSTIFICATIVA
// ,CANCELADA
// ,ND_PISCOFINS_BICMS
//,IDNFE
// ,IPI_NC
// ,V_IPI_NC
// ,ICMS_NC
// ,V_ICMS_NC
// ,ENDERECO_PRESENTE
// ,NOTA_PRESENTE
//   //,'S' AS REGIME_UTILIZADO  //pendente adicionar regime de enquagramento
// ,OBS_ESTORNO
// ,CODRE_ISS_RET
// ,CODRE_INSS_RET
// ,CODRE_COFINS_RET
// ,CODRE_PIS_RET
// ,CODRE_CSSL_RET
// ,CODRE_IRRF_RET
// ,B_ISS_RET
// ,V_ISS_RET
// ,DTVEN_ISS_RET
// ,B_INSS_RET
// ,V_INSS_RET
// ,DTVEN_INSS_RET
// ,B_COFINS_RET
// ,V_COFINS_RET
// ,DTVEN_COFINS_RET
// ,B_PIS_RET
// ,V_PIS_RET
// ,DTVEN_PIS_RET
// ,B_CSSL_RET
// ,V_CSSL_RET
// ,DTVEN_CSSL_RET
// ,B_IRRF_RET
// ,V_IRRF_RET
// ,DTVEN_IRRF_RET
// ,COD_SERVICO_DES
// ,DATA_CANCELOU
// //,STATUS
// ///,IDPROTOCOLO
// //,MENSAGEMNFE
// //,NAOINCIDE_FRETEIPI
// //,NAOINCIDE_FRETESUBST_ICMS
// //,AFRMM
// //,B_AFRMM
// //,V_AFRMM
// //,MOD_B20K
// //,NECF_B20L
// //,NCOO_B20M
// //,TIPO_CTE
// //,IND_NAT_FRT
// //,NAOINCIDE_SEGUROIPI
// //,NAOINCIDE_DESPESASIPI
 //,REF_DATA
 //,REF_CUF
 //,REF_CNPJ
 //,REF_SERIE
 //,REF_NNF
 //,V_FCP_UF_DEST
 //,V_ICMS_UF_DEST
 //,V_ICMS_UF_REMET
 //,IE_ST_FILIAL
 //,CALCULAR_PARTILHA
 //,ZERARPARTILHA_REMET
 //,CONTRIBUINTE
 //,IDNFE_REF
 //,CESTA_BASICA
 //,TOTAL_ICMSS_SEP
 //,IDRECIBO
 //,NOTA_ENTREGA_CONTA_ORDEM
 //,ENDERECO_ENTREGA_CONTA_ORDEM
 //,V_FCP
 //,V_FCPST
 //,V_FCPSTRET
 //,TRUE  AS IMPORTXML
 ,TRUE  AS USUARIO
FROM NF N1
  INNER JOIN SAIDAS       S ON S.SAIDA = N1.COD_OPERACAO
  INNER JOIN FILIAIS      F  ON F.FILIAL = S.FILIAL
  INNER JOIN FORNECEDORES FO ON FO.GERADOR = F.GERADOR
WHERE N1.CANCELADA = 'F'
  AND N1.TIPO_OPERACAO = 'S'
  //AND N1.COD_OPERACAO  = :COD_OPERACAO;


#CALL:DOC MILLENIUM.UTILS.DEFAULT( NOME="ROMANEIO", TAMANHO=6);

#CALL:MOV MILLENIUM.MOVIMENTACAO.EXECUTA(
   EVENTO                  =:EV.EVENTO
  ,FILIAL                  =:FL.FILIAL
  ,FORNECEDOR              =:FO.FORNECEDOR
  ,CONDICOES_PGTO          =:CP.CONDICOES_PGTO
  ,CONTA                   =:FL.CONTA
//,PCONTA                  =:FILIAL_FRANQUIA.PCONTA
  ,ROMANEIO                =:DOC.RESULT
  ,DATA                    =:DATA
  ,OBS                     =:OBS
  ,TRANSPORTADORA          =:TRANSP.TRANSPORTADORA
  ,USUARIO                 =#USER()
  ,DATA_BASE               =:DATA
  ,DATA_ATUALIZACAO        =#NOW()
  ,PRODUTOS                =:PRODUTOS_MOVIMENTO
  //,LANCAMENTOS             =:LANCAMENTOS_MOVIMENTO
  //,NOTAS                   =:NOTA_MOVIMENTO
  ,MODALIDADE_FRETE        =:MODALIDADE_FRETE
  ,NUMERACAO_NOTA_AUTO     =FALSE
  ,PESO_L                  =:PESO_LIQUIDO
  ,PESO_B                  =:PESO_BRUTO
  ,VOLUME                  =:QUANTIDADE_VOLUME
  ,QTDE                    =:QUANTIDADE_TOTAL
  ,VALOR_FINAL             =:VALOR_FINAL
  ,V_FRETE                 =:VALOR_FRETE
  ,CORTESIA                =:VALOR_CORTESIA
  ,TOTAL                   =:VALOR_TOTAL_PRODUTOS
  //,V_SEGURO                =:MOVIMENTACAO_SAIDA.V_SEGURO
  //,ACERTO                  =:MOVIMENTACAO_SAIDA.ACERTO
  //,V_ACERTO                =:MOVIMENTACAO_SAIDA.V_ACERTO
  //,ESPECIE_VOLUME          =:MOVIMENTACAO_SAIDA.ESPECIE_VOLUME
  //,DESPESAS_ACES           =:MOVIMENTACAO_SAIDA.DESPESAS_ACES
);


</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>