<?xml version="1.0"?>
<root>
  <OBJECT NAME="PERFIL_IMPOSTOS">
    <METHOD NAME="Atualizar_NCM" DESCRIPTION="Atualizar NCM" VERSION="18" TRIGGEROF="PERFIL_IMPOSTOS.INCLUI" TRIGGERTYPE="0" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="PERFIL_IMPOSTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Perfil Imposto" CTAB="0"/>
        <PARAM NAME="PERFIL_IMPOSTO_NCM" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Perfil Imposto Ncm" NESTEDNAME="millenium!pmz.PERFIL_IMPOSTOS.PERFIL_IMPOSTO_NCM" CTAB="0"/>
        <PARAM NAME="PERFIL_IMPOSTO_NCM_PREFIXO" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Perfil Imposto Ncm Prefixo" NESTEDNAME="millenium!pmz.PERFIL_IMPOSTOS.PERFIL_IMPOSTO_NCM_PREFIXO" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>#PRIVATE()
  #SET(TAB_NCM,${#CREATETABLE(PERFIL_IMPOSTO INTEGER,CLASSIFICACAO_FIS INTEGER)})
    #PRIVATE()
      CREATE INDEX #REPLACE(TAB_NCM)_1 ON #REPLACE(TAB_NCM) (PERFIL_IMPOSTO, CLASSIFICACAO_FIS);
        #EACH() PERFIL_IMPOSTO_NCM AS G;
          INSERT INTO #REPLACE(TAB_NCM) (PERFIL_IMPOSTO,CLASSIFICACAO_FIS)
          VALUES (:PERFIL_IMPOSTO, :G.CLASSIFICACAO_FIS);

#PRIVATE()
  #SET(TAB_NCM_PREFIXO,${#CREATETABLE(PERFIL_IMPOSTO INTEGER,PERFIL_IMPOSTO_NCM_PREFIXO INTEGER)})
    #PRIVATE()
      CREATE INDEX #REPLACE(TAB_NCM_PREFIXO)_1 ON #REPLACE(TAB_NCM_PREFIXO) (PERFIL_IMPOSTO,PERFIL_IMPOSTO_NCM_PREFIXO);
        #EACH() PERFIL_IMPOSTO_NCM_PREFIXO AS GF;
          INSERT INTO #REPLACE(TAB_NCM_PREFIXO) (PERFIL_IMPOSTO,PERFIL_IMPOSTO_NCM_PREFIXO)
          VALUES (:PERFIL_IMPOSTO, :GF.PERFIL_IMPOSTO_NCM_PREFIXO);

//Validar tabela com registro vazio
#CHECK("select count(*) as n from #REPLACE(TAB_NCM) T where T.CLASSIFICACAO_FIS is null",n>0,"N&#227;o permitida inclus&#227;o para NCM vazio.");

//Validar duplidade de NCM
#CHECK("SELECT COUNT(T.CLASSIFICACAO_FIS) AS N FROM #REPLACE(TAB_NCM) T GROUP BY T.CLASSIFICACAO_FIS HAVING COUNT(T.CLASSIFICACAO_FIS)>1 ",N>1,"Informe o NCM uma &#250;nica vez!");

//Validar NCM em outro perfil de imposto
#CHECK("SELECT COUNT(PG.CLASSIFICACAO_FIS) AS N FROM #REPLACE(TAB_NCM) T INNER JOIN PMZ_PERFIL_IMPOSTO_NCM PG ON PG.CLASSIFICACAO_FIS=T.CLASSIFICACAO_FIS WHERE PG.PERFIL_IMPOSTO&lt;>T.PERFIL_IMPOSTO ",N>0,"N&#227;o permitida inclus&#227;o do NCM em mais de 1 Perfil de Imposto");

//Validar tabela com registro de prefixo NCM
#CHECK("SELECT COUNT(T.PERFIL_IMPOSTO_NCM_PREFIXO) AS N FROM #REPLACE(TAB_NCM_PREFIXO) T WHERE #STR_LEN(T.PERFIL_IMPOSTO_NCM_PREFIXO)&lt;4 OR (#STR_LEN(T.PERFIL_IMPOSTO_NCM_PREFIXO)>6)",N>0,"O prefixo de NCM deve ser fixado em 4,5 OU 6 digitos");

DELETE FROM PMZ_PERFIL_IMPOSTO_NCM_PREFIXO WHERE PERFIL_IMPOSTO=:PERFIL_IMPOSTO;
#EACH()
SELECT:GF2 * FROM #REPLACE(TAB_NCM_PREFIXO)
#BEGIN
   INSERT INTO PMZ_PERFIL_IMPOSTO_NCM_PREFIXO(PERFIL_IMPOSTO, PERFIL_IMPOSTO_NCM_PREFIXO)
      VALUES (:GF2.PERFIL_IMPOSTO, :GF2.PERFIL_IMPOSTO_NCM_PREFIXO);
#END;

DELETE FROM PMZ_PERFIL_IMPOSTO_NCM WHERE PERFIL_IMPOSTO=:PERFIL_IMPOSTO;

#EACH()
SELECT:NCM
  GC.PERFIL_IMPOSTO,
  COALESCE(CF6.CLASSIFICACAO_FIS,
    COALESCE(CF5.CLASSIFICACAO_FIS,
      COALESCE(CF4.CLASSIFICACAO_FIS,CF.CLASSIFICACAO_FIS)
    )
  ) AS CLASSIFICACAO_FIS
FROM PERFIL_IMPOSTOS GC
  LEFT JOIN #REPLACE(TAB_NCM) NCM ON NCM.PERFIL_IMPOSTO = GC.PERFIL_IMPOSTO
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P4 ON NCM_P4.PERFIL_IMPOSTO = GC.PERFIL_IMPOSTO
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P5 ON NCM_P5.PERFIL_IMPOSTO = GC.PERFIL_IMPOSTO
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P6 ON NCM_P6.PERFIL_IMPOSTO = GC.PERFIL_IMPOSTO
  LEFT JOIN CLASSIFICACAO_FIS CF  ON CF.CLASSIFICACAO_FIS = NCM.CLASSIFICACAO_FIS
  LEFT JOIN CLASSIFICACAO_FIS CF4 ON SUBSTRING(CF4.DESCRICAO,1,4) = NCM_P4.PERFIL_IMPOSTO_NCM_PREFIXO
  LEFT JOIN CLASSIFICACAO_FIS CF5 ON SUBSTRING(CF5.DESCRICAO,1,5) = NCM_P5.PERFIL_IMPOSTO_NCM_PREFIXO
  LEFT JOIN CLASSIFICACAO_FIS CF6 ON SUBSTRING(CF6.DESCRICAO,1,6) = NCM_P6.PERFIL_IMPOSTO_NCM_PREFIXO
WHERE GC.PERFIL_IMPOSTO = :PERFIL_IMPOSTO
GROUP BY
  GC.PERFIL_IMPOSTO,
  COALESCE(CF6.CLASSIFICACAO_FIS,
    COALESCE(CF5.CLASSIFICACAO_FIS,
      COALESCE(CF4.CLASSIFICACAO_FIS,CF.CLASSIFICACAO_FIS)
    )
  )

#BEGIN
   INSERT INTO PMZ_PERFIL_IMPOSTO_NCM(PERFIL_IMPOSTO,CLASSIFICACAO_FIS)
     VALUES(:NCM.PERFIL_IMPOSTO,:NCM.CLASSIFICACAO_FIS)
       #RETURN(PERFIL_IMPOSTO_NCM);
#END;



</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>