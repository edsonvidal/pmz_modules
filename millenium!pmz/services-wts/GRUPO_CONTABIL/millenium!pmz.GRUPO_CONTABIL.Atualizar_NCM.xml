<?xml version="1.0"?>
<root>
  <OBJECT NAME="GRUPO_CONTABIL">
    <METHOD NAME="Atualizar_NCM" DESCRIPTION="Atualizar NCM" VERSION="44" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="GRUPO_CONTABIL" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Grupo Contabil" CTAB="0"/>
        <PARAM NAME="GRUPO_CONTABIL_NCM" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Grupo Contabil Ncm" NESTEDNAME="millenium!pmz.GRUPO_CONTABIL.GRUPO_CONTABIL_NCM" CTAB="0"/>
        <PARAM NAME="GRUPO_CONTABIL_NCM_PREFIXO" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Grupo Contabil Ncm Prefixo" NESTEDNAME="millenium!pmz.GRUPO_CONTABIL.GRUPO_CONTABIL_NCM_PREFIXO" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>#PRIVATE()
  #SET(TAB_NCM,${#CREATETABLE(GRUPO_CONTABIL INTEGER,CLASSIFICACAO_FIS INTEGER)})
    #PRIVATE()
      CREATE INDEX #REPLACE(TAB_NCM)_1 ON #REPLACE(TAB_NCM) (GRUPO_CONTABIL, CLASSIFICACAO_FIS);
        #EACH() GRUPO_CONTABIL_NCM AS G;
          INSERT INTO #REPLACE(TAB_NCM) (GRUPO_CONTABIL,CLASSIFICACAO_FIS)
          VALUES (:GRUPO_CONTABIL, :G.CLASSIFICACAO_FIS);

#PRIVATE()
  #SET(TAB_NCM_PREFIXO,${#CREATETABLE(GRUPO_CONTABIL INTEGER,GRUPO_CONTABIL_NCM_PREFIXO INTEGER)})
    #PRIVATE()
      CREATE INDEX #REPLACE(TAB_NCM_PREFIXO)_1 ON #REPLACE(TAB_NCM_PREFIXO) (GRUPO_CONTABIL,GRUPO_CONTABIL_NCM_PREFIXO);
        #EACH() GRUPO_CONTABIL_NCM_PREFIXO AS GF;
          INSERT INTO #REPLACE(TAB_NCM_PREFIXO) (GRUPO_CONTABIL,GRUPO_CONTABIL_NCM_PREFIXO)
          VALUES (:GRUPO_CONTABIL, :GF.GRUPO_CONTABIL_NCM_PREFIXO);
//Validar tabela com registro vazio
#CHECK("select count(*) as n from #REPLACE(TAB_NCM) T where T.CLASSIFICACAO_FIS is null",n>0,"N&#227;o permitida inclus&#227;o para NCM vazio.");

//Validar duplidade de NCM
#CHECK("SELECT COUNT(T.CLASSIFICACAO_FIS) AS N FROM #REPLACE(TAB_NCM) T GROUP BY T.CLASSIFICACAO_FIS HAVING COUNT(T.CLASSIFICACAO_FIS)>1 ",N>1,"Informe o NCM uma &#250;nica vez!");

//Validar NCM em outro grupo comtabil
#CHECK("SELECT COUNT(PG.CLASSIFICACAO_FIS) AS N FROM #REPLACE(TAB_NCM) T INNER JOIN PMZ_GRUPO_CONTABIL_NCM PG ON PG.CLASSIFICACAO_FIS=T.CLASSIFICACAO_FIS WHERE PG.GRUPO_CONTABIL&lt;>T.GRUPO_CONTABIL ",N>0,"N&#227;o permitida inclus&#227;o do NCM em mais de 1 Grupo Contabil");

//Validar tabela com registro de prefixo NCM
#CHECK("SELECT COUNT(T.GRUPO_CONTABIL_NCM_PREFIXO) AS N FROM #REPLACE(TAB_NCM_PREFIXO) T WHERE #STR_LEN(T.GRUPO_CONTABIL_NCM_PREFIXO)&lt;4 OR (#STR_LEN(T.GRUPO_CONTABIL_NCM_PREFIXO)>6)",N>0,"O prefixo de NCM deve ser fixado em 4,5 OU 6 digitos");

DELETE FROM PMZ_GRUPO_CONTABIL_NCM_PREFIXO WHERE GRUPO_CONTABIL=:GRUPO_CONTABIL;
#EACH()
SELECT:GF2 * FROM #REPLACE(TAB_NCM_PREFIXO)
#BEGIN
   INSERT INTO PMZ_GRUPO_CONTABIL_NCM_PREFIXO(GRUPO_CONTABIL, GRUPO_CONTABIL_NCM_PREFIXO)
      VALUES (:GF2.GRUPO_CONTABIL, :GF2.GRUPO_CONTABIL_NCM_PREFIXO);
#END;

DELETE FROM PMZ_GRUPO_CONTABIL_NCM WHERE GRUPO_CONTABIL=:GRUPO_CONTABIL;

#EACH()
SELECT:NCM
  GC.GRUPO_CONTABIL,
    COALESCE(CF6.CLASSIFICACAO_FIS,
    COALESCE(CF5.CLASSIFICACAO_FIS,
      COALESCE(CF4.CLASSIFICACAO_FIS,CF.CLASSIFICACAO_FIS)
    )
  ) AS CLASSIFICACAO_FIS
FROM PMZ_GRUPO_CONTABIL GC
  LEFT JOIN #REPLACE(TAB_NCM) NCM ON NCM.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P ON NCM_P.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P4 ON NCM_P4.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P5 ON NCM_P5.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P6 ON NCM_P6.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN CLASSIFICACAO_FIS CF  ON CF.CLASSIFICACAO_FIS = NCM.CLASSIFICACAO_FIS
  LEFT JOIN CLASSIFICACAO_FIS CF4 ON SUBSTRING(CF4.DESCRICAO,1,4) = NCM_P4.GRUPO_CONTABIL_NCM_PREFIXO
  LEFT JOIN CLASSIFICACAO_FIS CF5 ON SUBSTRING(CF5.DESCRICAO,1,5) = NCM_P5.GRUPO_CONTABIL_NCM_PREFIXO
  LEFT JOIN CLASSIFICACAO_FIS CF6 ON SUBSTRING(CF6.DESCRICAO,1,6) = NCM_P6.GRUPO_CONTABIL_NCM_PREFIXO
WHERE GC.GRUPO_CONTABIL = :GRUPO_CONTABIL
GROUP BY
  GC.GRUPO_CONTABIL,
  COALESCE(CF6.CLASSIFICACAO_FIS,
    COALESCE(CF5.CLASSIFICACAO_FIS,
      COALESCE(CF4.CLASSIFICACAO_FIS,CF.CLASSIFICACAO_FIS)
    )
  )

#BEGIN
   INSERT INTO PMZ_GRUPO_CONTABIL_NCM(GRUPO_CONTABIL,CLASSIFICACAO_FIS)
     VALUES(:NCM.GRUPO_CONTABIL,:NCM.CLASSIFICACAO_FIS)
       #RETURN(GRUPO_CONTABIL_NCM);
#END;








</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>