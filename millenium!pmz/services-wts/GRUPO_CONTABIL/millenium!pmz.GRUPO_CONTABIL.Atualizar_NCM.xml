<?xml version="1.0"?>
<root>
  <OBJECT NAME="GRUPO_CONTABIL">
    <METHOD NAME="Atualizar_NCM" DESCRIPTION="Atualizar NCM" VERSION="25" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="GRUPO_CONTABIL" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Grupo Contabil" CTAB="0"/>
        <PARAM NAME="GRUPO_CONTABIL_NCM" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Grupo Contabil Ncm" NESTEDNAME="millenium!pmz.GRUPO_CONTABIL.GRUPO_CONTABIL_NCM" CTAB="0"/>
        <PARAM NAME="GRUPO_CONTABIL_NCM_PREFIXO" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Grupo Contabil Ncm Prefixo" NESTEDNAME="millenium!pmz.GRUPO_CONTABIL.GRUPO_CONTABIL_NCM_PREFIXO" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>#SET(TAB_NCM,${#CREATETABLE(GRUPO_CONTABIL INTEGER,CLASSIFICACAO_FIS INTEGER)})
#EACH() GRUPO_CONTABIL_NCM AS G;
    INSERT INTO #REPLACE(TAB_NCM) (GRUPO_CONTABIL,CLASSIFICACAO_FIS)
      VALUES (:GRUPO_CONTABIL, :G.CLASSIFICACAO_FIS);

#SET(TAB_NCM_PREFIXO,${#CREATETABLE(GRUPO_CONTABIL INTEGER,GRUPO_CONTABIL_NCM_PREFIXO INTEGER)})
  #EACH() GRUPO_CONTABIL_NCM_PREFIXO AS GF;
   INSERT INTO #REPLACE(TAB_NCM_PREFIXO) (GRUPO_CONTABIL,GRUPO_CONTABIL_NCM_PREFIXO)
      VALUES (:GRUPO_CONTABIL, :GF.GRUPO_CONTABIL_NCM_PREFIXO);
      
//Validar tabela com registro vazio
#CHECK("select count(*) as n from #REPLACE(TAB_NCM) T where T.CLASSIFICACAO_FIS is null",n>0,"N&#227;o permitida inclus&#227;o para NCM vazio.");

//Validar duplidade de NCM
#CHECK("SELECT COUNT(T.CLASSIFICACAO_FIS) AS N FROM #REPLACE(TAB_NCM) T GROUP BY T.CLASSIFICACAO_FIS HAVING COUNT(T.CLASSIFICACAO_FIS)>1 ",N>1,"Informe o NCM uma &#250;nica vez!");

//Validar NCM em outro grupo comtabil
#CHECK("SELECT COUNT(PG.CLASSIFICACAO_FIS) AS N FROM #REPLACE(TAB_NCM) T INNER JOIN PMZ_GRUPO_CONTABIL_NCM PG ON PG.CLASSIFICACAO_FIS=T.CLASSIFICACAO_FIS WHERE PG.GRUPO_CONTABIL&lt;>T.GRUPO_CONTABIL ",N>0,"N&#227;o permitida inclus&#227;o do NCM em mais de 1 Grupo Contabil");

//Validar tabela com registro vazio
#CHECK("SELECT COUNT(T.GRUPO_CONTABIL_NCM_PREFIXO) AS N FROM #REPLACE(TAB_NCM_PREFIXO) T WHERE #STR_LEN(T.GRUPO_CONTABIL_NCM_PREFIXO)&lt;>4",N>0,"O prefixo de NCM deve ser fixado em 4 digitos");

DELETE FROM PMZ_GRUPO_CONTABIL_NCM_PREFIXO WHERE GRUPO_CONTABIL=:GRUPO_CONTABIL;
#EACH()
SELECT:GF2 * FROM #REPLACE(TAB_NCM_PREFIXO)
#BEGIN
   INSERT INTO PMZ_GRUPO_CONTABIL_NCM_PREFIXO(GRUPO_CONTABIL, GRUPO_CONTABIL_NCM_PREFIXO)
      VALUES (:GF2.GRUPO_CONTABIL, :GF2.GRUPO_CONTABIL_NCM_PREFIXO);
#END;

DELETE FROM PMZ_GRUPO_CONTABIL_NCM WHERE GRUPO_CONTABIL=:GRUPO_CONTABIL;

#EACH()
SELECT:NCM
  GC.GRUPO_CONTABIL,
  COALESCE(CF2.CLASSIFICACAO_FIS,CF1.CLASSIFICACAO_FIS) AS CLASSIFICACAO_FIS
FROM PMZ_GRUPO_CONTABIL GC
  LEFT JOIN #REPLACE(TAB_NCM) NCM ON NCM.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN #REPLACE(TAB_NCM_PREFIXO) NCM_P ON NCM_P.GRUPO_CONTABIL = GC.GRUPO_CONTABIL
  LEFT JOIN CLASSIFICACAO_FIS CF1 ON CF1.CLASSIFICACAO_FIS = NCM.CLASSIFICACAO_FIS
  LEFT JOIN CLASSIFICACAO_FIS CF2 ON SUBSTRING(CF2.DESCRICAO,1,4) = NCM_P.GRUPO_CONTABIL_NCM_PREFIXO
WHERE GC.GRUPO_CONTABIL = :GRUPO_CONTABIL
GROUP BY
  GC.GRUPO_CONTABIL,
  COALESCE(CF2.CLASSIFICACAO_FIS,CF1.CLASSIFICACAO_FIS)

#BEGIN
   INSERT INTO PMZ_GRUPO_CONTABIL_NCM(GRUPO_CONTABIL,CLASSIFICACAO_FIS)
     VALUES(:NCM.GRUPO_CONTABIL,:NCM.CLASSIFICACAO_FIS)
       #RETURN(GRUPO_CONTABIL_NCM);
#END;



</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>