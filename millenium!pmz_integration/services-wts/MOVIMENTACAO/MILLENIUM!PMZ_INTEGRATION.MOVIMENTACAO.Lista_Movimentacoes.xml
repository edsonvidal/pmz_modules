<?xml version="1.0"?>
<root>
  <OBJECT NAME="MOVIMENTACAO">
    <METHOD NAME="Lista_Movimentacoes" DESCRIPTION="Lista Movimenta&#231;&#245;es" VERSION="103" INTFTYPE="5" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="TRANS_ID" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Trans_id para a listagem das notas fiscais, as notas fiscais ser&#227;o listadas a partir desse trans_id. Trans_id &#233; um campo num&#233;rico que indica quando um item foi alterado" ORDER="4" FIELDLABEL="Trans Id" CTAB="0"/>
        <PARAM NAME="DATA_EMISSAO_INICIAL" FORMAT="H" SIZE="18" FLAGS="1" PROJECTION="0" HINT="!Data de emiss&#227;o Inicial" ORDER="2" FIELDLABEL="Data Emiss&#227;o Inicial" CTAB="0"/>
        <PARAM NAME="DATA_EMISSAO_FINAL" FORMAT="H" SIZE="18" FLAGS="1" PROJECTION="0" HINT="!Data de emiss&#227;o final" ORDER="1" FIELDLABEL="Data Emiss&#227;o Final" CTAB="0"/>
        <PARAM NAME="ROMANEIO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Romaneio" CTAB="0"/>
        <PARAM NAME="DIGITADA" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="5" FIELDLABEL="Digitada" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="COD_FILIAL" SIZE="10" FLAGS="17" PROJECTION="0" ORDER="12" FIELDLABEL="Cod Filial" CTAB="0"/>
        <FIELD NAME="CNPJ_CPF_DESTINATARIO" SIZE="18" FLAGS="17" PROJECTION="0" ORDER="8" FIELDLABEL="Cnpj Cpf Destinatario" CTAB="0"/>
        <FIELD NAME="COD_EVENTO" SIZE="5" FLAGS="17" PROJECTION="0" HINT="C&#243;digo do Evento No Millennium" ORDER="11" FIELDLABEL="Cod Evento" CTAB="0"/>
        <FIELD NAME="DATA" FORMAT="D" SIZE="10" FLAGS="17" PROJECTION="0" ORDER="15" FIELDLABEL="Data" CTAB="0"/>
        <FIELD NAME="COD_CONDICAO_PGTO" SIZE="3" FLAGS="17" PROJECTION="0" ORDER="10" FIELDLABEL="Cod Condicao Pgto" CTAB="0"/>
        <FIELD NAME="COD_TABELA_PRECO" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="13" FIELDLABEL="Cod Tabela Preco" CTAB="0"/>
        <FIELD NAME="OBS" SIZE="200" FLAGS="1" PROJECTION="0" ORDER="18" FIELDLABEL="Obs" CTAB="0"/>
        <FIELD NAME="CNPJ_TRANSPORTADORA" SIZE="18" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="Cnpj Transportadora" CTAB="0"/>
        <FIELD NAME="PRODUTOS" FORMAT="R" FLAGS="1" STYLE="3" PROJECTION="0" ORDER="31" FIELDLABEL="Produtos" NESTEDNAME="MILLENIUM!PMZ_INTEGRATION.MOVIMENTACAO.PRODUTOS" CTAB="0"/>
        <FIELD NAME="LANCAMENTOS" FORMAT="R" FLAGS="1" STYLE="3" PROJECTION="0" ORDER="29" FIELDLABEL="Lancamentos" NESTEDNAME="MILLENIUM!PMZ_INTEGRATION.MOVIMENTACAO.LANCAMENTOS" CTAB="0"/>
        <FIELD NAME="NOTAS" FORMAT="R" FLAGS="1" STYLE="3" PROJECTION="0" ORDER="30" FIELDLABEL="Notas" NESTEDNAME="MILLENIUM!PMZ_INTEGRATION.MOVIMENTACAO.NOTAS" CTAB="0"/>
        <FIELD NAME="PESO_LIQUIDO" FORMAT="N" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="20" FIELDLABEL="Peso Liquido" CTAB="0"/>
        <FIELD NAME="PESO_BRUTO" FORMAT="N" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="19" FIELDLABEL="Peso Bruto" CTAB="0"/>
        <FIELD NAME="QUANTIDADE_VOLUME" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="22" FIELDLABEL="Quantidade Volume" CTAB="0"/>
        <FIELD NAME="QUANTIDADE_TOTAL" FORMAT="N" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="21" FIELDLABEL="Quantidade Total" CTAB="0"/>
        <FIELD NAME="VALOR_FINAL" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="26" FIELDLABEL="Valor Final" CTAB="0"/>
        <FIELD NAME="VALOR_FRETE" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="27" FIELDLABEL="Valor Frete" CTAB="0"/>
        <FIELD NAME="VALOR_CORTESIA" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="25" FIELDLABEL="Valor Cortesia" CTAB="0"/>
        <FIELD NAME="VALOR_TOTAL_PRODUTOS" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="28" FIELDLABEL="Valor Total Produtos" CTAB="0"/>
        <FIELD NAME="FRETE_INFORMADO" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="Indica se o valor do frete foi infomado" ORDER="16" FIELDLABEL="Frete Informado" CTAB="0"/>
        <FIELD NAME="CONSIDERAR_FRETE_IMPOSTOS" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="Indica se &#233; para considerar valor do frete no impostos" ORDER="14" FIELDLABEL="Considerar Frete Impostos" CTAB="0"/>
        <FIELD NAME="MODALIDADE_FRETE" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="17" FIELDLABEL="Modalidade Frete" CTAB="0"/>
        <FIELD NAME="TIPO_GERADOR" SIZE="1" FLAGS="1" PROJECTION="0" HINT="Tipo de gerador (C=Cliente, F=Fornecedor)" ORDER="23" FIELDLABEL="Tipo Gerador" CTAB="0"/>
        <FIELD NAME="ACERTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Porcentagem de Desconto" ORDER="7" FIELDLABEL="Acerto" CTAB="0"/>
        <FIELD NAME="V_ACERTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Valor do Desconto" ORDER="24" FIELDLABEL="V Acerto" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>//M&#233;todo respons&#225;vel pela listagem de notas processadas no Millennium via sistema legado da PMZ ou pela pr&#243;prio ERP(Edson Vidal/Magdiel Araujo 09-06-2021)

SELECT:MAIN
  M.TIPO_OPERACAO
 ,M.COD_OPERACAO
 ,NF.TRANS_ID
 ,NF.NOTA
 ,M.TABELA
 ,MIN(F.COD_FILIAL)                    AS COD_FILIAL
 ,MIN(#NULL_TO_S(
   #NULL_TO_S(C.CGC,C.CPF),
   #NULL_TO_S(FO.CGC,FO.CPF)))         AS CNPJ_CPF_DESTINATARIO,
 ,MIN(EV.CODIGO)                       AS COD_EVENTO
 ,MIN(M.DATA)                          AS DATA
 ,MIN(TP.COD_TPRECO)                   AS COD_TABELA_PRECO
 ,MIN(CP.CODIGO)                       AS COD_CONDICAO_PGTO
 ,MIN(M.OBS)                           AS OBS
 ,MIN(T.COD_TRANSPORTADORA)            AS CNPJ_TRANSPORTADORA
 ,MIN(M.PESO_L)                        AS PESO_LIQUIDO
 ,MIN(M.PESO_B)                        AS PESO_BRUTO
 ,MIN(M.VOLUME)                        AS QUANTIDADE_VOLUME
 ,MIN(M.TOTAL)                         AS QUANTIDADE_TOTAL
 ,MIN(M.VALOR_FINAL)                   AS VALOR_FINAL
 ,MIN(M.V_FRETE)                       AS VALOR_FRETE
 ,MIN(M.CORTESIA)                      AS VALOR_CORTESIA
 ,MIN(M.QTDE)                          AS VALOR_TOTAL_PRODUTOS
 ,MIN(M.FRETE_INFORMADO)               AS FRETE_INFORMADO
 ,NULL                                 AS CONSIDERAR_FRETE_IMPOSTOS
 ,MIN(M.MODALIDADE_FRETE)              AS MODALIDADE_FRETE
 ,MIN(M.VOLUME)                        AS TIPO_GERADOR
 ,MIN(M.ACERTO)                        AS ACERTO
 ,MIN(M.V_ACERTO)                      AS V_ACERTO
  #ROWSET({
   SELECT:PRODUTOS
    PE.PRODUTO
   ,PE.COR
   ,PE.ESTAMPA
   ,PE.TAMANHO
   ,PE.ITEM
   ,MIN(P.COD_PRODUTO)            AS COD_PRODUTO
   ,SUM(PE.QUANTIDADE)            AS QUANTIDADE
   ,AVG(PE.PRECO)                 AS PRECO
   ,MIN(P.TIPO_PROD)              AS TIPO_PROD
   ,SUM(PE.B_PIS)                 AS B_PIS
   ,SUM(PE.B_COFINS)              AS B_COFINS
   ,SUM(PE.B_FCP)                 AS B_FCP
   ,MIN(PE.ICM)                   AS AL_ICMS
   ,SUM(PE.V_ICMS)                AS V_ICMS
   ,MIN(PE.PIS)                   AS AL_PIS
   ,SUM(PE.V_PIS)                 AS V_PIS
   ,MIN(PE.COFINS)                AS AL_COFINS
   ,SUM(PE.V_COFINS)              AS V_COFINS
   ,SUM(PE.BICM)                  AS BICM
   ,SUM(PE.BICMSUB)               AS BICMSUB
   ,SUM(PE.V_ICMSS)               AS ICMSS
   ,MIN(PE.ICM)                   AS ICM
   ,MIN(PE.FCP)                   AS FCP
   ,MIN(PE.PIS)                   AS PIS
   ,MIN(PE.COFINS)                AS COFINS
   ,SUM(PE.V_PIS)                 AS V_PIS
   ,SUM(PE.V_FCP)                 AS V_FCP
   ,SUM(PE.V_ICMS)                AS V_ICMS
   ,SUM(PE.V_ICMSS)               AS V_ICMSS
   ,SUM(PE.V_COFINS)              AS V_COFINS
   ,MIN(PE.TAXA_ICMSS)            AS TAXA_ICMSS
   ,MIN(PE.NOTA)                  AS NOTA
   ,MIN(PE.CF_ICMS)               AS CF_ICMS
   ,MIN(PE.CF_IPI)                AS CF_IPI
   ,MIN(PE.CF_CST_IPI)            AS CF_CST_IPI
   ,MIN(PE.CF_CST_PIS)            AS CF_CST_PIS
   ,MIN(PE.CF_CST_COFINS)         AS CF_CST_COFINS
   ,SUM(PE.BIPI)                  AS BIPI
   ,MIN(PE.IPI)                   AS IPI
   ,SUM(PE.V_IPI)                 AS V_IPI
   ,SUM(PE.B_ISS)                 AS B_ISS
   ,SUM(PE.V_ISS)                 AS V_ISS
   ,SUM(PE.DESC_SUFRAMA)          AS DESC_SUFRAMA
   ,MIN(PE.COD_NOTA)              AS COD_NOTA
   ,MIN(PE.DSC_NOTA_ORIG)         AS DSC_NOTA_ORIG
   ,SUM(PE.TOTAL_LIQUIDO)         AS TOTAL_LIQUIDO
   ,MIN(PE.SIT_TRIB)              AS SIT_TRIB
   ,SUM(PE.QUANTIDADE*PE.PRECO )  AS TOTAL_BRUTO
   ,SUM(PE.V_ICMS_UF_DEST)        AS V_ICMS_UF_DEST
   ,SUM(PE.V_ICMS_UF_DEST)        AS V_ICMS_UF_REMET
   ,MIN(CFOP.NAT_OPERACAO)        AS DESC_CFOP
   ,MIN(PE.DESCONTO)              AS DESCONTO
   ,MIN(PE.NOTA_REF)              AS NOTA_REF
   ,SUM(PE.BCUF_DEST)             AS BCUF_DEST
   ,MIN(PE.FCP_UF_DEST)           AS FCP_UF_DEST
   ,MIN(PE.ICMS_UF_DEST)          AS ICMS_UF_DEST
   ,MIN(PE.ICMS_INT)              AS ICMS_INT
   ,MIN(PE.ICMS_INTER_PART)       AS ICMS_INTER_PART
   ,(SELECT
       FIRST 1 CB.BARRA
     FROM CODIGO_BARRAS CB
     WHERE CB.TIPO_BARRA = 3
     AND CB.PRODUTO = PE.PRODUTO
     AND CB.COR = PE.COR
     AND CB.ESTAMPA = PE.ESTAMPA
     AND CB.TAMANHO = PE.TAMANHO
     AND CB.QUANTIDADE = 1
     AND CB.FORNECEDOR IS NULL) AS ID
  FROM PRODUTOS_EVENTOS PE
    INNER JOIN PRODUTOS P ON P.PRODUTO = PE.PRODUTO
    LEFT JOIN CFOP ON CFOP.CFOP = PE.CFOP
    LEFT JOIN CLASSIFICACAO_FIS CF ON CF.CLASSIFICACAO_FIS = P.CLASSIFICACAO_FIS
  WHERE PE.COD_OPERACAO = :MAIN.COD_OPERACAO
    AND PE.TIPO_OPERACAO = :MAIN.TIPO_OPERACAO
    AND PE.NOTA = :MAIN.NOTA
  GROUP BY
    PE.PRODUTO
   ,PE.COR
   ,PE.ESTAMPA
   ,PE.TAMANHO
   ,PE.ITEM
  ORDER BY
    PE.PRODUTO
   ,PE.COR
   ,PE.ESTAMPA
   ,PE.TAMANHO
   ,PE.ITEM
  })
  #ROWSET({
   SELECT:LANCAMENTOS
     L.LANCAMENTO
    ,MIN(L.N_DOCUMENTO)          AS N_DOCUMENTO
    ,MIN(L.DATA_EMISSAO)         AS DATA_EMISSAO
    ,MIN(L.DATA_VENCIMENTO)      AS DATA_VENCIMENTO
    ,MIN(L.VALOR_INICIAL)        AS VALOR_INICIAL
    ,MIN(L.NUMPARC)              AS NUMPARC
    ,MIN(L.PARCELA)              AS PARCELA
    ,MIN(L.DUPLICATA)            AS DUPLICATA
    ,MIN(TP.DESCRICAO)           AS DESC_TIPO_PGTO
   FROM LANCAMENTOS L
   INNER JOIN TIPOS_PGTOS TP ON TP.TIPO_PGTO = L.TIPO_PGTO
     WHERE L.ORIGEM = :MAIN.COD_OPERACAO
      AND L.TIPO_ORIGEM = :MAIN.TIPO_OPERACAO
   GROUP BY
     LANCAMENTO
  })
  #ROWSET({
   SELECT:NOTAS
     N.COD_OPERACAO
    ,N.TIPO_OPERACAO
    ,MIN(N.NOTA)                    AS NOTA
    ,MIN(N.ICMS)                    AS ICMS
    ,MIN(N.V_ICMS)                  AS V_ICMS
    ,MIN(N.VALOR)                   AS VALOR
    ,MIN(N.IPI)                     AS IPI
    ,MIN(N.V_IPI)                   AS V_IPI
    ,MIN(N.ICMSS)                   AS ICMSS
    ,MIN(N.V_ICMSS)                 AS V_ICMSS
    ,MIN(N.NUMERO_NOTA)             AS NUMERO_NOTA
    ,MIN(N.SERIE)                   AS SERIE
    ,MIN(N.DATA)                    AS DATA
    ,MIN(N.TIPO_NOTA)               AS TIPO_NOTA
    ,MIN(N.V_PIS)                   AS V_PIS
    ,MIN(N.B_PIS)                   AS B_PIS
    ,MIN(N.V_COFINS)                AS V_COFINS
    ,MIN(N.B_COFINS)                AS B_COFINS
    ,MIN(N.DESC_SUFRAMA)            AS DESC_SUFRAMA
    ,MIN(N.IDNFE)                   AS IDNFE
    ,MIN(N.IDRECIBO)                AS IDRECIBO
    ,MIN(N.DIGITADA)                AS DIGITADA
    ,MIN(N.IDPROTOCOLO)             AS IDPROTOCOLO
    ,MIN(NM.CODIGO)                 AS COD_MODELO
    ,MIN(N.IDNFE_REF)               AS IDNFE_REF
    ,MIN(N.REF_SERIE)               AS REF_SERIE
    ,MIN(N.REF_CNPJ)                AS REF_CNPJ
    ,MIN(N.REF_NNF)                 AS REF_NNF
   FROM NF N
   LEFT JOIN NF_MODELOS NM ON NM.NF_MODELO = N.MODELO
   WHERE N.COD_OPERACAO = :MAIN.COD_OPERACAO
     AND N.TIPO_OPERACAO = :MAIN.TIPO_OPERACAO
   GROUP BY
     N.COD_OPERACAO
    ,N.TIPO_OPERACAO
  })
FROM MOVIMENTO M
  INNER JOIN EVENTOS EV ON EV.EVENTO = M.EVENTO
  INNER JOIN NF ON NF.COD_OPERACAO = M.COD_OPERACAO AND NF.TIPO_OPERACAO = M.TIPO_OPERACAO
  INNER JOIN FILIAIS F ON F.FILIAL = NF.FILIAL
  LEFT JOIN TABELAS_PRECO TP ON TP.TABELA = M.TABELA
  LEFT JOIN CONDICOES_PGTO CP ON CP.CONDICOES_PGTO = M.CONDICOES_PGTO
  LEFT JOIN TRANSPORTADORAS T ON T.TRANSPORTADORA = M.TRANSPORTADORA
  LEFT JOIN CLIENTES C ON C.CLIENTE = M.CLIENTE
  LEFT JOIN FORNECEDORES FO ON FO.FORNECEDOR = M.FORNECEDOR
WHERE M.CANCELADA = 'F'
  [AND NF.TRANS_ID > :TRANS_ID]
  [AND NF.TSS_NFE BETWEEN :DATA_EMISSAO_INICIAL AND :DATA_EMISSAO_FINAL]
  [AND M.ROMANEIO = :ROMANEIO]
  [AND NF.DIGITADA = :DIGITADA]
GROUP BY
  M.TIPO_OPERACAO
 ,M.COD_OPERACAO
 ,NF.TRANS_ID
 ,NF.NOTA
 ,M.TABELA
ORDER BY
  NF.TRANS_ID
 ,M.COD_OPERACAO
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>