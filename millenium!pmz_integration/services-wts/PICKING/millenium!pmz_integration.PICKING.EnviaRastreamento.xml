<?xml version="1.0"?>
<root>
  <OBJECT NAME="PICKING">
    <METHOD NAME="EnviaRastreamento" DESCRIPTION="Envia o c&#243;digo de rastreamento" VERSION="22" INTFTYPE="17" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="NUMERO" SIZE="20" FLAGS="1" PROJECTION="0" HINT="N&#250;mero da Separa&#231;&#227;o" ORDER="1" FIELDLABEL="Numero" CTAB="0"/>
        <PARAM NAME="NUMERO_OBJETO" SIZE="50" FLAGS="1" PROJECTION="0" HINT="N&#250;mero do Objeto para Rastreamento" ORDER="2" FIELDLABEL="Numero Objeto" CTAB="0"/>
        <PARAM NAME="URL_TRACKING_OBJETO" SIZE="512" FLAGS="1" PROJECTION="0" FIELDLABEL="Url Tracking Objeto" CTAB="0"/>
        <PARAM NAME="VOLUMES" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Volumes" NESTEDNAME="millenium!pmz_integration.PICKING.VOLUMES" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="STATUS" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="5" FIELDLABEL="Status" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>#EACH() VOLUMES as V99;
#CHECK("SELECT COUNT(*) as N FROM VOLUMES_EVENTO WHERE NUMERO_OBJETO=:V99.NUMERO_OBJETO",n>0,"Numero do rastreio ja cadastrado");

#CHECK("SELECT COUNT(*) as N FROM VOLUMES_EVENTO WHERE NUMERO_OBJETO=:NUMERO_OBJETO",n>0,"Numero do rastreio ja cadastrado");

#PRIVATE()
SELECT:pf numero FROM prefaturamentos where numero = cast(#substr(cast(:numero as varchar(20)),1,15) as varchar(15))
union all select null from dual;

#PRIVATE()
SELECT:aux #if(cast(:pf.numero as varchar(20)) is not null,cast('1' as varchar(1)), cast(#substr(cast(:numero as varchar(20)),1,1) as varchar(1))) as tipo,
           #if(cast(:pf.numero as varchar(20)) is not null,cast(:numero as varchar(20)), cast(#substr(cast(:numero as varchar(20)),2,20) as varchar(20)) ) as NUMERO
           FROM DUAL;

#CHECK("SELECT COUNT(*) as N FROM PREFATURAMENTO#SELECT(aux.tipo,1:'S',else:'_T') WHERE NUMERO=:aux.NUMERO",n=0,"N&#227;o encontrado");


#SELECT(aux.tipo,1:{
#private()
SELECT:MAIN PREFATURAMENTO, PEDIDOV FROM PREFATURAMENTOS WHERE NUMERO=:aux.NUMERO;
#private()
SELECT:MOV COD_OPERACAO FROM PRODUTOS_EVENTOS WHERE PRE_FATURAMENTO=:MAIN.PREFATURAMENTO AND TIPO_OPERACAO = 'S';
#private()
SELECT:VOL VOLUME_EVENTO FROM VOLUMES_EVENTO
WHERE TIPO_OPERACAO = 'F' AND COD_OPERACAO=:MAIN.PREFATURAMENTO;


#SELECT(VOL._EOF,TRUE:{
INSERT INTO VOLUMES_EVENTO (COD_OPERACAO, TIPO_OPERACAO, NUMERO_OBJETO, URL_TRACKING_OBJETO)
VALUES (:MAIN.PREFATURAMENTO,'F',:NUMERO_OBJETO,:URL_TRACKING_OBJETO) #RETURN(VOLUME_EVENTO)},
ELSE:{UPDATE VOLUMES_EVENTO SET NUMERO_OBJETO=:NUMERO_OBJETO, URL_TRACKING_OBJETO=:URL_TRACKING_OBJETO
WHERE VOLUME_EVENTO = :VOL.VOLUME_EVENTO});

#private()
SELECT:V3 TIPO_VOLUME FROM TIPOS_VOLUME;
#EACH() VOLUMES as V1;
DELETE FROM VOLUMES_EVENTO WHERE TIPO_OPERACAO = "F" and COD_OPERACAO=:MAIN.PREFATURAMENTO;
#EACH() VOLUMES as V2;
INSERT INTO VOLUMES_EVENTO (cod_operacao, tipo_operacao, tipo_volume, peso, pesokg, numero_objeto , URL_TRACKING_OBJETO)
      VALUES (:MAIN.PREFATURAMENTO, "F", :v3.tipo_volume, #NULL_TO_Z(:V2.PESO), (#NULL_TO_Z(:V2.PESO)/1000), :V2.NUMERO_OBJETO, :V2.URL_TRACKING_OBJETO)
      #RETURN(volume_evento);


#SELECT(mov._eof:true:{},else:{
#private()
SELECT:VO1 VOLUME_EVENTO FROM VOLUMES_EVENTO
WHERE TIPO_OPERACAO = 'S' AND COD_OPERACAO=:MOV.COD_OPERACAO;

#SELECT(VO1._EOF,TRUE:{
INSERT INTO VOLUMES_EVENTO (COD_OPERACAO, TIPO_OPERACAO, NUMERO_OBJETO, URL_TRACKING_OBJETO)
VALUES (:MOV.COD_OPERACAO,'S',:NUMERO_OBJETO,:URL_TRACKING_OBJETO) #RETURN(VOLUME_EVENTO)},
ELSE:{UPDATE VOLUMES_EVENTO SET NUMERO_OBJETO=:NUMERO_OBJETO, URL_TRACKING_OBJETO=:URL_TRACKING_OBJETO
WHERE VOLUME_EVENTO = :VO1.VOLUME_EVENTO});

#private()
SELECT:V4 TIPO_VOLUME FROM TIPOS_VOLUME;
#EACH() VOLUMES as V5;
DELETE FROM VOLUMES_EVENTO WHERE TIPO_OPERACAO = "S" and COD_OPERACAO=:MOV.COD_OPERACAO;
#EACH() VOLUMES as V6;
INSERT INTO VOLUMES_EVENTO (cod_operacao, tipo_operacao, tipo_volume, peso, pesokg, numero_objeto, URL_TRACKING_OBJETO)
      VALUES (:MOV.COD_OPERACAO, "S", :v4.tipo_volume, #NULL_TO_Z(:V6.PESO), (#NULL_TO_Z(:V6.PESO)/1000), :V6.NUMERO_OBJETO, :V6.URL_TRACKING_OBJETO)
      #RETURN(volume_evento);
})

},else:{})

SELECT PEDIDOV, "PROCESSADO" as STATUS FROM PREFATURAMENTO#SELECT(aux.tipo,1:'S',else:'_T') WHERE NUMERO=:aux.NUMERO;

</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>