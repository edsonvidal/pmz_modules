<?xml version="1.0"?>
<root>
  <OBJECT NAME="PICKING">
    <METHOD NAME="ListaNovos" DESCRIPTION="Lista Prefaturamentos que podem ser conferidos" VERSION="116" INTFTYPE="5" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="QTD_ITENS" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Quantidade m&#225;xima de itens que retornar&#227;o na consulta" ORDER="1" FIELDLABEL="Qtd Itens" CTAB="0"/>
        <PARAM NAME="TRANS_ID" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Trans Id" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="NUMERO" SIZE="20" FLAGS="1" PROJECTION="0" HINT="N&#250;mero da Separa&#231;&#227;o" ORDER="32" FIELDLABEL="Numero" CTAB="0"/>
        <FIELD NAME="CNPJ_CLIENTE" SIZE="20" FLAGS="1" PROJECTION="0" HINT="CNPJ ou CPF do cliente" ORDER="15" FIELDLABEL="Cpf Cliente" CTAB="0"/>
        <FIELD NAME="COD_CLIENTE" SIZE="15" FLAGS="1" PROJECTION="0" HINT="CPF do cliente do pedido" ORDER="23" FIELDLABEL="Cnpj Cliente" CTAB="0"/>
        <FIELD NAME="PRODUTOS" FORMAT="R" FLAGS="1" PROJECTION="0" HINT="Produtos para Separar" ORDER="25" FIELDLABEL="Cnpj Transportadora" NESTEDNAME="millenium!pmz_integration.PICKING.PRODUTO" CTAB="0"/>
        <FIELD NAME="CNPJ_TRANSPORTADORA" SIZE="20" FLAGS="1" PROJECTION="0" HINT="CNPJ da transportadora do pedido" ORDER="35" FIELDLABEL="Produtos" CTAB="0"/>
        <FIELD NAME="CNPJ_FILIAL" SIZE="20" FLAGS="1" PROJECTION="0" HINT="CNPJ da filial do pedido" ORDER="24" FIELDLABEL="Cnpj Filial" CTAB="0"/>
        <FIELD NAME="DATA" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" HINT="Data do pedido" ORDER="26" FIELDLABEL="Data" CTAB="0"/>
        <FIELD NAME="END_ENTREGA" SIZE="100" FLAGS="1" PROJECTION="0" HINT="Logradouro do endere&#231;o do pedido" ORDER="28" FIELDLABEL="End Entrega" CTAB="0"/>
        <FIELD NAME="NUM_ENTREGA" SIZE="20" FLAGS="1" PROJECTION="0" HINT="Numero do endere&#231;o do pedido" ORDER="31" FIELDLABEL="Num Entrega" CTAB="0"/>
        <FIELD NAME="CMP_ENTREGA" SIZE="40" FLAGS="1" PROJECTION="0" HINT="Complemento do endere&#231;o do pedido" ORDER="21" FIELDLABEL="Cmp Entrega" CTAB="0"/>
        <FIELD NAME="BAI_ENTREGA" SIZE="40" FLAGS="1" PROJECTION="0" HINT="Bairro do endere&#231;o do pedido" ORDER="18" FIELDLABEL="Bai Entrega" CTAB="0"/>
        <FIELD NAME="CID_ENTREGA" SIZE="40" FLAGS="1" PROJECTION="0" HINT="Cidade do endere&#231;o do pedido" ORDER="20" FIELDLABEL="Cid Entrega" CTAB="0"/>
        <FIELD NAME="EST_ENTREGA" SIZE="2" FLAGS="1" PROJECTION="0" HINT="Estado do endere&#231;o do pedido" ORDER="29" FIELDLABEL="Est Entrega" CTAB="0"/>
        <FIELD NAME="CEP_ENTREGA" SIZE="9" FLAGS="1" PROJECTION="0" HINT="CEP do endere&#231;o do pedido" ORDER="19" FIELDLABEL="Cep Entrega" CTAB="0"/>
        <FIELD NAME="CNPJ_ENTREGA" SIZE="20" FLAGS="1" PROJECTION="0" HINT="CNPJ do cliente do pedido" ORDER="22" FIELDLABEL="Cnp Entrega" CTAB="0"/>
        <FIELD NAME="IE_ENTREGA" SIZE="20" FLAGS="1" PROJECTION="0" HINT="Identificador estadual (IE)" ORDER="30" FIELDLABEL="Ie Entrega" CTAB="0"/>
        <FIELD NAME="TOTAL" FORMAT="N" SIZE="12" FLAGS="1" DECIMALS="2" PROJECTION="0" HINT="Total do pedido" ORDER="38" FIELDLABEL="Total" CTAB="0"/>
        <FIELD NAME="PESOKG" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="4" PROJECTION="0" HINT="Peso total dos volumes" ORDER="33" FIELDLABEL="Pesokg" CTAB="0"/>
        <FIELD NAME="QUANTIDADE" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="Quantidade do pedido" ORDER="36" FIELDLABEL="Quantidade" CTAB="0"/>
        <FIELD NAME="PREFATURAMENTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id do prefaturamento " ORDER="34" FIELDLABEL="Prefaturamento" CTAB="0"/>
        <FIELD NAME="TRANSPORTADORA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id da transportadora" ORDER="39" FIELDLABEL="Transportadora" CTAB="0"/>
        <FIELD NAME="TIPO_FRETE" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id do tipo de frete" ORDER="37" FIELDLABEL="Tipo Frete" CTAB="0"/>
        <FIELD NAME="DESC_TIPO_FRETE" SIZE="30" FLAGS="1" PROJECTION="0" HINT="Descri&#231;&#227;o do tipo de frete" ORDER="27" FIELDLABEL="Desc Tipo Frete" CTAB="0"/>
        <FIELD NAME="COD_PEDIDOV" SIZE="20" FLAGS="1" PROJECTION="0" HINT="C&#243;digo do pedido" ORDER="14" FIELDLABEL="Cod Pedidov" CTAB="0"/>
        <FIELD NAME="DATA_ENTREGA" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" HINT="Data de entrega" ORDER="16" FIELDLABEL="Data Entrega" CTAB="0"/>
        <FIELD NAME="PESO_PEDIDO" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="4" PROJECTION="0" HINT="Peso total do pedido baseado nos produtos" ORDER="17" FIELDLABEL="Peso Pedido" CTAB="0"/>
        <FIELD NAME="OPERACAO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="C&#243;digo da opera&#231;&#227;o (tipo_pedido)" ORDER="13" FIELDLABEL="Tipo Pedido" CTAB="0"/>
        <FIELD NAME="COD_FILIAL" SIZE="10" FLAGS="1" PROJECTION="0" HINT="C&#243;digo da filial" ORDER="11" FIELDLABEL="Cod Filial" CTAB="0"/>
        <FIELD NAME="NOME_CLIENTE" SIZE="120" FLAGS="1" PROJECTION="0" HINT="Nome do cliente" ORDER="12" FIELDLABEL="Nome Cliente" CTAB="0"/>
        <FIELD NAME="V_FRETE" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" HINT="Valor do frete" ORDER="10" FIELDLABEL="Valor do frete" CTAB="0"/>
        <FIELD NAME="V_ACERTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Valor de acerto no pedido" ORDER="9" FIELDLABEL="Valor do Acerto" CTAB="0"/>
        <FIELD NAME="ACERTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Percentual de acerto no pedido" ORDER="5" FIELDLABEL="Acerto" CTAB="0"/>
        <FIELD NAME="CORTESIA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Valor de corteria no pedido" ORDER="7" FIELDLABEL="Cortesia" CTAB="0"/>
        <FIELD NAME="COD_CONDICAO_PGTO" SIZE="5" FLAGS="1" PROJECTION="0" HINT="C&#243;digo da condi&#231;&#227;o de pagamento" ORDER="6" FIELDLABEL="Cod Condicao Pgto" CTAB="0"/>
        <FIELD NAME="LANCAMENTOS" FORMAT="R" FLAGS="1" PROJECTION="0" HINT="Lista de lan&#231;amentos do pedido" ORDER="8" FIELDLABEL="Lancamentos" NESTEDNAME="millenium!pmz_integration.PICKING.LANCAMENTOS" CTAB="0"/>
        <FIELD NAME="TRANS_ID" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="TransId do prefaturamento" ORDER="4" FIELDLABEL="Trans Id" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>#SELECT(QTD_ITENS,0:{},
               ELSE:{#TOP(:QTD_ITENS)})
SELECT:MAIN
   PF.PREFATURAMENTO
  ,PF.TRANS_ID,
  ,PF.NUMERO AS NUMERO
  ,#NULL_TO_S(#NULL_TO_S(#SUBSTRING(G.CNPJ,2,19),G.CGC),G.CPF) AS CNPJ_CLIENTE,
  ,G.NOME AS NOME_CLIENTE,
  ,G.CPF AS CPF_CLIENTE,
  ,G.COD_CLIENTE AS COD_CLIENTE
  ,#NULL_TO_S(#SUBSTRING(F.CNPJ,2,19),F.CGC) AS CNPJ_FILIAL,
  ,#NULL_TO_S(#SUBSTRING(T.CNPJ,2,19),T.CGC) AS CNPJ_TRANSPORTADORA,
  ,PF.DATA
  ,PV.DATA_ENTREGA
  ,#NULL_TO_S(EC.LOGRADOURO2,EC.LOGRADOURO) AS END_ENTREGA,
  ,EC.NUMERO AS NUM_ENTREGA,
  ,EC.COMPLEMENTO AS CMP_ENTREGA,
  ,EC.BAIRRO AS BAI_ENTREGA,
  ,EC.CIDADE AS CID_ENTREGA,
  ,EC.ESTADO AS EST_ENTREGA,
  ,EC.CEP AS CEP_ENTREGA,
  ,#NULL_TO_S(PF.TRANSPORTADORA,PV.TRANSPORTADORA) AS TRANSPORTADORA,
  ,#NULL_TO_S(PF.TIPO_FRETE,PV.TIPO_FRETE) AS TIPO_FRETE,
  ,TF.DESCRICAO AS DESC_TIPO_FRETE,
  ,PV.COD_PEDIDOV,
  ,CPG.CODIGO AS COD_CONDICAO_PGTO,
  ,PV.CORTESIA,
  ,PV.V_ACERTO,
  ,PV.ACERTO,
  ,#NULL_TO_S(PF.V_FRETE,PV.V_FRETE) AS V_FRETE,
  ,#NULL_TO_S(#NULL_TO_S(EC.CNPJ,#NULL_TO_S(#SUBSTRING(G.CNPJ,2,19),G.CGC)),G.CPF) AS CNPJ_ENTREGA,
  ,#NULL_TO_S(EC.IE,G.IE) AS IE_ENTREGA,
  ,PV.TOTAL,
  ,PV.QUANTIDADE,
  ,(SELECT SUM(#NULL_TO_Z(VE.PESOKG))
    FROM VOLUMES_EVENTO VE
    WHERE VE.TIPO_OPERACAO="F" AND VE.COD_OPERACAO=PF.PREFATURAMENTO) AS PESOKG,
  ,(SELECT SUM((#NULL_TO_Z(P.PESO) * #NULL_TO_Z(PFT.QUANTIDADE)))
    FROM PRODUTO_PREFAT PFT
    INNER JOIN PRODUTOS P ON P.PRODUTO = PFT.PRODUTO
    WHERE PFT.PREFATURAMENTO = PF.PREFATURAMENTO) AS PESO_PEDIDO,
    PV.TIPO_PEDIDO AS OPERACAO,
    F.COD_FILIAL,
   
 #ROWSET({SELECT:PRODUTOS
            PF.PRODUTO,
            PF.COR,
            PF.ESTAMPA,
            PF.TAMANHO,
            PF.ITEM,
            MIN(P.COD_PRODUTO)                      AS COD_PRODUTO,
            MIN(P.DESCRICAO1 || ' ' || C.DESCRICAO) AS DESCRICAO,
            SUM(PF.QUANTIDADE)                      AS QUANTIDADE ,
            AVG(PPV.PRECO)                          AS PRECO,
            AVG(PPV.DESCONTO)                       AS DESCONTO,
            (SELECT FIRST 1
               CB.BARRA
             FROM CODIGO_BARRAS CB
             WHERE CB.PRODUTO = PF.PRODUTO
               AND CB.COR = PF.COR
               AND CB.ESTAMPA = PF.ESTAMPA
               AND CB.TAMANHO=PF.TAMANHO
               AND (CB.QUANTIDADE IS NULL OR CB.QUANTIDADE=1)
               AND CB.FORNECEDOR IS NULL
               AND CB.TIPO_BARRA = 3 )              AS ID
          FROM PRODUTO_PREFAT PF
            INNER JOIN PRODUTOS P ON PF.PRODUTO = P.PRODUTO
            INNER JOIN ESTAMPAS E ON E.ESTAMPA = PF.ESTAMPA
            INNER JOIN CORES C ON C.COR = PF.COR
            INNER JOIN PREFATURAMENTOS PREF ON PREF.PREFATURAMENTO=PF.PREFATURAMENTO
            INNER JOIN PRODUTO_PEDIDOV PPV ON PPV.PEDIDOV=PREF.PEDIDOV
                                          AND PPV.PRODUTO=PF.PRODUTO
										  AND PPV.COR=PF.COR
										  AND PPV.ESTAMPA=PF.ESTAMPA
										  AND PPV.TAMANHO=PF.TAMANHO
         WHERE PF.PREFATURAMENTO = :MAIN.PREFATURAMENTO
           AND PF.QUANTIDADE>0
         GROUP BY PF.PRODUTO,PF.COR,PF.ESTAMPA,PF.TAMANHO,PF.ITEM
       })
   #ROWSET({SELECT:LANCAMENTOS
              L.LANCAMENTO
             ,MIN(L.N_DOCUMENTO)          AS N_DOCUMENTO
             ,MIN(L.DATA_EMISSAO)         AS DATA_EMISSAO
             ,MIN(L.DATA_VENCIMENTO)      AS DATA_VENCIMENTO
             ,MIN(L.VALOR_INICIAL)        AS VALOR_INICIAL
             ,MIN(L.NUMPARC)              AS NUMPARC
             ,MIN(L.PARCELA)              AS PARCELA
             ,MIN(L.DUPLICATA)            AS DUPLICATA
             ,MIN(TP.TIPO_PGTO)           AS TIPO_PGTO
             FROM LANCAMENTOS L
             INNER JOIN TIPOS_PGTOS TP ON TP.TIPO_PGTO = L.TIPO_PGTO
             INNER JOIN PEDIDO_VENDA PV ON PV.PEDIDOV = L.ORIGEM AND L.TIPO_ORIGEM='V' AND L.TIPO='R'
             INNER JOIN PREFATURAMENTOS PFF ON PFF.PEDIDOV = PV.PEDIDOV
             WHERE PFF.PREFATURAMENTO = :MAIN.PREFATURAMENTO
             GROUP BY LANCAMENTO
           })
 FROM PREFATURAMENTOS PF
 INNER JOIN CLIENTES G ON PF.CLIENTE = G.CLIENTE
 INNER JOIN FILIAIS F ON F.FILIAL = PF.FILIAL
 INNER JOIN PEDIDO_VENDA PV ON PV.PEDIDOV = PF.PEDIDOV
 LEFT JOIN CONDICOES_PGTO CPG ON PV.CONDICOES_PGTO = CPG.CONDICOES_PGTO
 LEFT JOIN TRANSPORTADORAS T ON T.TRANSPORTADORA = #NULL_TO_S(PF.TRANSPORTADORA,PV.TRANSPORTADORA)
 LEFT JOIN ENDERECOS_CADASTRO EC ON EC.GERADOR = G.GERADOR AND EC.COD_ENDERECO = PV.COD_ENDERECO
 LEFT JOIN TIPOS_FRETE TF ON TF.TIPO_FRETE = #NULL_TO_S(PF.TIPO_FRETE,PV.TIPO_FRETE)
 WHERE PF.EXPEDICAO = TRUE
   AND PF.PODECONFERIR = TRUE
   AND PF.CONFERINDO = FALSE
   AND PF.CONFERIDO = FALSE
   AND PF.ENTREGUE = FALSE
   AND PF.EXCLUIDO = FALSE
  [AND PF.TRANS_ID >=:TRANS_ID]
ORDER BY PF.TRANS_ID
;
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>